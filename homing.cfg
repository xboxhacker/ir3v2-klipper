# Homing order: Z -> X -> Y
# Z homing: enable Z motor, move 0.1mm, then set Z to 0.0 (marks Z as homed).
# X and Y homing use the printer's original G28 behavior (renamed to G990028).
# If the user requests G28 Y only and Z isn't homed yet, this macro will home Z first.

[gcode_macro G28]
rename_existing: G990028
description: Home axes in order Z -> X -> Y; custom Z homing (enable, move 0.1mm, set Z=0)
gcode:
  G90

  {% set homed = printer.toolhead.homed_axes|lower %}
  {% set full_home = (params|length == 0) %}

  # 1) Home Z (always first for full-home; or if explicitly requested)
  {% if full_home or 'Z' in params %}
    SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1
    G91
    G1 Z0.1 F120
    G90
    SET_KINEMATIC_POSITION Z=0.0
  {% endif %}

  # 2) Home X (second for full-home; or if explicitly requested)
  {% if full_home or 'X' in params %}
    G990028 X
  {% endif %}

  # 3) Home Y (last for full-home; or if explicitly requested)
  # If Y-only was requested but Z isn't homed yet, home Z first per your requirement.
  {% if 'Y' in params and 'z' not in homed and not full_home %}
    SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1
    G91
    G1 Z0.1 F120
    G90
    SET_KINEMATIC_POSITION Z=0.0
  {% endif %}
  {% if full_home or 'Y' in params %}
    G990028 Y
  {% endif %}