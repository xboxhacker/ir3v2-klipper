# Homing strategy for belt printer:
# - Z uses physical endstop (no probe).
# - Y homes using the probe virtual endstop (BDsensor).
# - Ensure X and Z are prepared before homing Y so the BDsensor can trigger.

[gcode_macro G28]
rename_existing: G990028
description: Home axes in order X -> Z -> Y; prep for probe-based Y homing
gcode:
  G90
  {% set safe_x = 15.0 %}     # Put the BDsensor over the belt (x_offset = -15 means nozzle X=15 places probe at Xâ‰ˆ0)
  {% set y_probe_z = 2.0 %}   # Gap for reliable BDsensor triggering during Y homing; tune if needed
  {% set homed = printer.toolhead.homed_axes|lower %}

  # Full home (no axis params): X -> Z -> prepare -> Y
  {% if not params %}
    G990028 X
    G1 X{safe_x} F6000
    G990028 Z
    G1 Z{y_probe_z} F600
    G990028 Y
    {% endmacro %}

  # Partial homes
  {% if 'X' in params %}
    G990028 X
  {% endif %}

  {% if 'Z' in params %}
    G990028 Z
  {% endif %}

  {% if 'Y' in params %}
    # Ensure X is homed and positioned so the probe is over the belt
    {% if 'x' not in homed %}
      G990028 X
    {% endif %}
    G1 X{safe_x} F6000

    # Ensure Z is homed and set to a suitable height for the BDsensor to trigger
    {% if 'z' not in homed %}
      G990028 Z
    {% endif %}
    G1 Z{y_probe_z} F600

    # Now home Y using probe virtual endstop
    G990028 Y
  {% endif %}

# Optional helpers
[gcode_macro G28X]
gcode:
  G90
  G990028 X

[gcode_macro G28Z]
gcode:
  G90
  G990028 Z

[gcode_macro G28Y]
gcode:
  G90
  {% set safe_x = 15.0 %}
  {% set y_probe_z = 2.0 %}
  {% set homed = printer.toolhead.homed_axes|lower %}
  {% if 'x' not in homed %}
    G990028 X
  {% endif %}
  G1 X{safe_x} F6000
  {% if 'z' not in homed %}
    G990028 Z
  {% endif %}
  G1 Z{y_probe_z} F600
  G990028 Y
